#!/usr/bin/ruby
# frozen_string_literal: true

longest_streak = streak = 0

# -- Exit gracefully --
Signal.trap('INT') do
  puts "\nLongest streak: #{longest_streak}"
  exit 0
end

def print_header
  puts '----------------------------------------------------------'
  puts '                      THE GIT GAME                        '
  puts '----------------------------------------------------------'
  puts 'Welcome! The goal of the git game is to guess committers'
  puts "based on their commit messages.\n\n"
end

def print_help
  puts '----------------------------------------------------------'
  puts '                          USAGE                           '
  puts '----------------------------------------------------------'
  puts 'git game [extra git log options]'
  puts 'EX: git game --after={2014-08-08}'
  puts '(This script already uses --no-merges and --pretty.'
  puts 'For more valid options see: http://gitref.org/inspect/)'
end

# -- Usage Text --
input = nil
if ARGV.count.positive?
  input = ARGV.shift

  case input
  when 'help'
    print_header
    print_help
    exit 0
  end
end

# -- Fetch Repository Info --
commit_shas = `git log --no-merges --pretty=%H -z #{input}`
              .split("\0")
              .shuffle
committers = `git log --no-merges --pretty=%aN | sort -u`
             .split("\n")

# -- Show welcome message --
system('clear')

print_header
puts "You're playing in a repo with #{commit_shas.size} commits and #{committers.size}"
puts "distinct committers.\n\n"

committers.each do |committer|
  puts committer
end

puts 'Ready? PRESS ENTER TO START PLAYING (Ctrl-C to quit)'

gets

system('clear')

# -- Game loop --
NUM_CHOICE = 4

loop do
  sha = commit_shas.pop
  author = `git show #{sha} --pretty=%aN --no-patch`.strip

  puts `git show #{sha} --pretty='(%ar)%n%B' --shortstat\n\n`

  choices = [author]
  choices += committers.reject do |name|
    name == author
  end.sample(NUM_CHOICE - 1)

  choices.shuffle.each_with_index do |name, index|
    puts "[#{index + 1}] #{name}"
  end

  print "Who wrote it (current streak: #{streak})? "

  guess = gets.strip

  until guess.to_i.between?(1, NUM_CHOICE)
    print "Who wrote it (current streak: #{streak})? "
    guess = gets.strip
  end

  if choices[guess.to_i - 1] == author
    streak += 1
    puts 'Got it!'
  else
    streak = 0
    puts "Actually, it was #{author}."
  end

  longest_streak = [longest_streak, streak].max

  sleep 1
  system('clear')
end
